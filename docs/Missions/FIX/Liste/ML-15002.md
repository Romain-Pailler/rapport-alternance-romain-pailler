---
sidebar_label: "ML-15002 – Sélection du loueur et comportement de la recherche"
sidebar_position: 2
tags:
  - Bug
  - Comptabilité
  - Pièces comptables
  - Recherche
---

# Anomalie sur le filtre loueur dans la recherche de pièces comptables

## Contexte

L’écran de recherche des **pièces comptables**, situé dans le module **Comptabilité**, permet à l’utilisateur de filtrer les factures selon plusieurs critères dont le loueur, le rôle du tiers, ou encore la période.

## Ticket 

![Screenshot du ticket Jira](/img/fix/ml_15002.png)

## Problème

Deux comportements inattendus ont été identifiés par Julien lors de l’utilisation du filtre *loueur* :

1. **Recherche déclenchée automatiquement**  
   Dès qu’un loueur était sélectionné, l’écran lançait une recherche sans que l’utilisateur clique sur le bouton **"Rechercher"**. Cela interrompait la configuration des autres filtres et pouvait entraîner des recherches incomplètes.

2. **Disparition du rôle "Client"**  
   Après avoir sélectionné puis retiré un loueur, la liste des rôles tiers perdait l’option **"Client"**, alors qu’elle aurait dû rester disponible.

Ces comportements étaient dus à des [effets de bord](../../../glossaire/Vocab.md#effet-de-bord) dans le [DOM](../../../glossaire/Vocab.md#dom) (manipulations déclenchant des actions involontaires), et à une mauvaise reconfiguration de la liste des types de tiers affichés.

## Correction

### Blocage du déclenchement automatique

Pour résoudre le problème du déclenchement prématuré, j’ai mis en place un système de contrôle à l’aide d’une variable shouldScroll.
Elle me permet de distinguer les modifications de filtre d’une action volontaire (comme le clic sur le bouton "Rechercher").

J’en ai aussi profité pour ajouter une sécurité sur le bouton de soumission du formulaire : il est désormais désactivé pendant le chargement, pour éviter les double-clics et d'avoir plusieurs appels vers le back-end.

### Rétablissement des rôles tiers

J’ai revu la logique de rafraîchissement de la liste des rôles tiers pour qu’elle reste cohérente, même après désélection d’un loueur.
Le rôle Client est maintenant toujours proposé, peu importe le contexte, comme il se doit.

## Code Source

### recherche-piece-comptable.component.html

```html
<button type="submit" mlUiButton [disabled]="searchLoading">
    <ml-ui-icon icon="search"></ml-ui-icon>
    <span i18n>Rechercher</span>
</button>
```

### recherche-piece-comptable.component.ts

```ts
  /**
   * Permet d'éviter l'effet de bord dû à la DOM (true si clique sur le bouton 'rechercher' false sinon)
   * @private
   */
  private shouldScroll: boolean = false;
```

#### Modifié

```diff
this.roleTiers = SortUtils.sortAlphabeticallyAsc<typeTiers>(
      [
         TYPE_TIERS.APPORTEUR,
         TYPE_TIERS.BAILLEUR,
+         TYPE_TIERS.CLIENT,
         TYPE_TIERS.GROUPE_APPORTEURS,
         TYPE_TIERS.SERVICE_PROTECTION,
       ],
       'libelle',
     );

```

## Résultat

Grâce à ces ajustements :

- La recherche se déclenche uniquement quand l’utilisateur le décide,
- L’interface ne perd plus d’options en cours de route,
- Et l’écran de recherche est globalement plus robuste et agréable à utiliser.

<video controls width="100%">
  <source src="/videos/ml_15002.mp4" type="video/mp4"/>
  Votre navigateur ne supporte pas la vidéo HTML5.
</video>

---
