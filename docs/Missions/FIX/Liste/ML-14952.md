---
sidebar_label: "ML-14952 – Recherche de pièces comptables par date"
sidebar_position: 7
tags:
  - Bug
  - Comptabilité
  - Pièces comptables
  - Recherche
---

# Correction du filtre "Pièce créée entre..." sur la recherche de pièces comptables

## Contexte

L’écran de recherche des **pièces comptables**, accessible depuis le menu **Comptabilité > Pièces comptables**, permet aux utilisateurs de filtrer les factures selon divers critères (n° de pièce, montant, type, rôle du tiers, etc.). Parmi ces filtres, le champ *« Pièce créée entre… et… »* permet normalement de cibler les pièces créées sur une période donnée.

Ce champ repose sur la **date de création réelle de la pièce dans Leasa**, visible dans les résultats sous la colonne *Date création*.

<video controls width="100%">
  <source src="/videos/ml_14952.mp4" type="video/mp4" />
  Votre navigateur ne supporte pas la vidéo HTML5.
</video>


## Problème

Jusqu’à récemment, le filtre de période utilisait par erreur la **date de facturation** au lieu de la **date de création effective**. Ce comportement entraînait des résultats incohérents : certaines pièces apparaissaient dans le tableau alors qu’elles ne respectaient pas la période renseignée, et d'autres étaient omises à tort.

Le filtre était donc inopérant en particulier lors de reportings mensuels ou annuels.

## Correction

Pour corriger ce bug, j’ai tout simplement réaligné la logique du filtre avec ce qui est effectivement affiché à l’écran. Concrètement, j’ai remplacé la date de facturation par la date de création comme base de filtrage, afin que les résultats correspondent vraiment à ce que l’utilisateur attend.

### Détail technique

Je suis intervenu dans le `FactureSearchBuilder` pour modifier les méthodes concernées. J’ai ciblé le champ `dateCreation` au lieu de `dateFacture` dans les conditions de début et de fin de période. Ce changement a permis de faire correspondre les filtres aux données affichées dans la colonne Date création.

```java
// Avant
where(Q_FACTURE.dateFacture.goe(getBeginningOfTheDay(dateDebut)));
// Après
where(Q_FACTURE.dateCreation.goe(getBeginningOfTheDay(dateDebut)));
```

### Résultat

Depuis cette correction, la recherche par date fonctionne de manière fiable. Les utilisateurs retrouvent exactement les pièces attendues selon la période renseignée notamment pour les reportings ou les contrôles de fin de mois. Une correction simple, mais qui améliore clairement l’expérience et la précision de l’outil.


### code source 

#### avant 

````java
   public FactureSearchBuilder whereDateDebut(final Date dateDebut) {
        if (dateDebut != null) {
            where(Q_FACTURE.dateFacture.goe(getBeginningOfTheDay(dateDebut)));
        }
        return this;
    }
   public FactureSearchBuilder whereDateFin(final Date dateFin) {
        if (dateFin != null) {
            where(Q_FACTURE.dateFacture.loe(getEndOfTheDay(dateFin)));
        }
        return this;
    }
````

#### après

```java
  public FactureSearchBuilder whereDateDebut(final Date dateDebut) {
        if (dateDebut != null) {
            where(Q_FACTURE.dateCreation.goe(getBeginningOfTheDay(dateDebut)));
        }
        return this;
    }
public FactureSearchBuilder whereDateFin(final Date dateFin) {
        if (dateFin != null) {
            where(Q_FACTURE.dateCreation.loe(getEndOfTheDay(dateFin)));
        }
        return this;
    }
```

---